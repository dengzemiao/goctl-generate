# Go-Zero å¼€å‘æµç¨‹é€ŸæŸ¥è¡¨

## ğŸš€ æ ‡å‡†å¼€å‘æµç¨‹ï¼ˆ5æ­¥ï¼‰

```
æ•°æ®åº“è®¾è®¡ â†’ ç”ŸæˆModel â†’ ç¼–å†™API â†’ ç”ŸæˆAPIä»£ç  â†’ å†™ä¸šåŠ¡é€»è¾‘
    â†“           â†“          â†“          â†“            â†“
 å»ºè¡¨SQL    model.sh    .apiæ–‡ä»¶    api.sh     logicå±‚
```

---

## ğŸ“‹ è¯¦ç»†æ­¥éª¤æ¸…å•

### â˜‘ï¸ ç¬¬1æ­¥ï¼šæ•°æ®åº“è®¾è®¡ï¼ˆ10åˆ†é’Ÿï¼‰

**ä»»åŠ¡ï¼š** è®¾è®¡å¹¶åˆ›å»ºæ•°æ®è¡¨

```sql
CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL COMMENT 'ç”¨æˆ·å',
  `password` varchar(255) NOT NULL COMMENT 'å¯†ç ',
  `email` varchar(100) DEFAULT NULL COMMENT 'é‚®ç®±',
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';
```

**æ³¨æ„äº‹é¡¹ï¼š**
- âœ… æ·»åŠ å¿…è¦çš„ç´¢å¼•
- âœ… å­—æ®µæ·»åŠ æ³¨é‡Š
- âœ… é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹
- âœ… è®¾ç½®åˆç†çš„å­—æ®µé•¿åº¦

---

### â˜‘ï¸ ç¬¬2æ­¥ï¼šç”Ÿæˆ Model å±‚ï¼ˆ2åˆ†é’Ÿï¼‰

**ä»»åŠ¡ï¼š** ä»æ•°æ®åº“è¡¨ç”Ÿæˆ Model ä»£ç 

```bash
# é…ç½®æ•°æ®åº“ï¼ˆé¦–æ¬¡ï¼‰
vim etc/test-api.yaml

# æµ‹è¯•è¿æ¥ï¼ˆæ¨èï¼‰
sh generate/model.sh --dry-run

# ç”Ÿæˆ Model
sh generate/model.sh -t user -s goZero

# æ£€æŸ¥ç”Ÿæˆç»“æœ
ls internal/model/
```

**ç”Ÿæˆç»“æœï¼š**
- `usermodel.go` - Model æ–‡ä»¶ï¼ˆè‡ªåŠ¨åŒ…å« CRUD æ–¹æ³•ï¼‰

**å¯é€‰ï¼šæ‰©å±• Model æ–¹æ³•**

```go
// åœ¨ usermodel.go ä¸­æ·»åŠ è‡ªå®šä¹‰æŸ¥è¯¢
func (m *defaultUserModel) FindOneByUsername(ctx context.Context, username string) (*User, error) {
    var user User
    query := "SELECT * FROM user WHERE username = ? LIMIT 1"
    err := m.conn.QueryRowCtx(ctx, &user, query, username)
    return &user, err
}
```

---

### â˜‘ï¸ ç¬¬3æ­¥ï¼šè®¾è®¡ API æ¥å£ï¼ˆ5åˆ†é’Ÿï¼‰

**ä»»åŠ¡ï¼š** ç¼–å†™ `.api` æ–‡ä»¶å®šä¹‰æ¥å£

```bash
vim api/user.api
```

**æ¨¡æ¿ï¼š**

```go
syntax = "v1"

// ========== è¯·æ±‚/å“åº”å®šä¹‰ ==========
type RegisterRequest {
    Username string `json:"username"`           // ç”¨æˆ·å
    Password string `json:"password"`           // å¯†ç 
    Email    string `json:"email,optional"`     // é‚®ç®±ï¼ˆå¯é€‰ï¼‰
}

type RegisterResponse {
    Code    int    `json:"code"`               // 0=æˆåŠŸ
    Message string `json:"message"`            // æç¤ºä¿¡æ¯
}

// ========== è·¯ç”±å®šä¹‰ ==========
@server(
    group: auth             // åˆ†ç»„ï¼šç”Ÿæˆåˆ° internal/logic/auth/
    prefix: api/user        // è·¯ç”±å‰ç¼€ï¼š/api/user/register
)
service test-api {
    @handler RegisterHandler    // Handler åç§°
    post /register (RegisterRequest) returns (RegisterResponse)
}
```

**éªŒè¯è¯­æ³•ï¼š**

```bash
sh generate/api.sh --validate
```

---

### â˜‘ï¸ ç¬¬4æ­¥ï¼šç”Ÿæˆ API ä»£ç ï¼ˆ1åˆ†é’Ÿï¼‰

**ä»»åŠ¡ï¼š** ç”Ÿæˆ Handler å’Œ Logic å±‚ä»£ç 

```bash
# ç”Ÿæˆä»£ç 
sh generate/api.sh -s goZero

# æŸ¥çœ‹ç”Ÿæˆç»“æœ
tree internal/
```

**ç”Ÿæˆæ–‡ä»¶æ¸…å•ï¼š**

```
internal/
â”œâ”€â”€ handler/
â”‚   â””â”€â”€ auth/
â”‚       â””â”€â”€ registerhandler.go    â† HTTP å…¥å£ï¼ˆä¸è¦†ç›–ï¼‰
â”œâ”€â”€ logic/
â”‚   â””â”€â”€ auth/
â”‚       â””â”€â”€ registerlogic.go      â† ä¸šåŠ¡é€»è¾‘ï¼ˆä¸è¦†ç›–ï¼‰â­ æ ¸å¿ƒ
â””â”€â”€ types/
    â””â”€â”€ types.go                  â† ç±»å‹å®šä¹‰ï¼ˆä¼šè¦†ç›–ï¼‰âš ï¸
```

---

### â˜‘ï¸ ç¬¬5æ­¥ï¼šç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰

**ä»»åŠ¡ï¼š** åœ¨ Logic å±‚å®ç°å…·ä½“ä¸šåŠ¡

```bash
vim internal/logic/auth/registerlogic.go
```

**ä»£ç æ¨¡æ¿ï¼š**

```go
func (l *RegisterLogic) Register(req *types.RegisterRequest) (*types.RegisterResponse, error) {
    // ========== ç¬¬1æ­¥ï¼šå‚æ•°æ ¡éªŒ ==========
    if len(req.Username) < 3 || len(req.Username) > 50 {
        return &types.RegisterResponse{
            Code:    400,
            Message: "ç”¨æˆ·åé•¿åº¦éœ€è¦ 3-50 ä¸ªå­—ç¬¦",
        }, nil
    }
    
    // ========== ç¬¬2æ­¥ï¼šä¸šåŠ¡é€»è¾‘æ£€æŸ¥ ==========
    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    existUser, err := l.svcCtx.UserModel.FindOneByUsername(l.ctx, req.Username)
    if err == nil && existUser != nil {
        return &types.RegisterResponse{
            Code:    400,
            Message: "ç”¨æˆ·åå·²å­˜åœ¨",
        }, nil
    }
    
    // ========== ç¬¬3æ­¥ï¼šå¯†ç åŠ å¯† ==========
    hashedPassword, err := bcrypt.GenerateFromPassword(
        []byte(req.Password), 
        bcrypt.DefaultCost,
    )
    if err != nil {
        return nil, err
    }
    
    // ========== ç¬¬4æ­¥ï¼šè°ƒç”¨ Model å±‚æ’å…¥æ•°æ® ==========
    _, err = l.svcCtx.UserModel.Insert(l.ctx, &model.User{
        Username: req.Username,
        Password: string(hashedPassword),
        Email:    req.Email,
    })
    if err != nil {
        logx.Errorf("æ’å…¥ç”¨æˆ·å¤±è´¥: %v", err)
        return nil, err
    }
    
    // ========== ç¬¬5æ­¥ï¼šè¿”å›å“åº” ==========
    return &types.RegisterResponse{
        Code:    0,
        Message: "æ³¨å†ŒæˆåŠŸ",
    }, nil
}
```

**ç¼–å†™é€»è¾‘çš„åŸåˆ™ï¼š**

| å±‚çº§ | èŒè´£ | å¯ä»¥åš | ä¸èƒ½åš |
|-----|------|--------|--------|
| **Handler** | HTTPå¤„ç† | æ¥æ”¶è¯·æ±‚ã€è¿”å›å“åº” | âŒ ä¸šåŠ¡é€»è¾‘ã€æ•°æ®åº“æ“ä½œ |
| **Logic** â­ | ä¸šåŠ¡é€»è¾‘ | å‚æ•°æ ¡éªŒã€æµç¨‹æ§åˆ¶ã€è°ƒç”¨Model | âŒ ç›´æ¥SQLæ“ä½œ |
| **Model** | æ•°æ®æ“ä½œ | æ•°æ®åº“ CRUD | âŒ ä¸šåŠ¡åˆ¤æ–­ |

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“è¡¨å·²åˆ›å»ºï¼Œå­—æ®µè®¾è®¡åˆç†
- [ ] Model å·²ç”Ÿæˆï¼Œæµ‹è¯•äº†åŸºç¡€ CRUD
- [ ] API æ–‡ä»¶å·²ç¼–å†™ï¼Œè¯­æ³•éªŒè¯é€šè¿‡
- [ ] API ä»£ç å·²ç”Ÿæˆï¼Œæ–‡ä»¶ç»“æ„æ­£ç¡®
- [ ] ä¸šåŠ¡é€»è¾‘å·²å®ç°ï¼ŒåŒ…å«å¿…è¦çš„æ ¡éªŒ
- [ ] æµ‹è¯•æ¥å£ï¼ŒåŠŸèƒ½æ­£å¸¸
- [ ] ä»£ç å·²æäº¤åˆ° Git

---

## ğŸ¯ å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# ========== Model ç”Ÿæˆ ==========
sh generate/model.sh                    # ç”Ÿæˆæ‰€æœ‰è¡¨
sh generate/model.sh -t user,order      # æŒ‡å®šè¡¨
sh generate/model.sh --dry-run          # æµ‹è¯•è¿æ¥
sh generate/model.sh -s goZero          # å°é©¼å³°å‘½å

# ========== API ç”Ÿæˆ ==========
sh generate/api.sh                      # ç”Ÿæˆä»£ç 
sh generate/api.sh --validate           # éªŒè¯è¯­æ³•
sh generate/api.sh -v                   # è¯¦ç»†æ¨¡å¼

# ========== å¸®åŠ© ==========
sh generate/model.sh --help
sh generate/api.sh --help
cat generate/README.yaml                # é…ç½®ç¤ºä¾‹

# ========== Git ç®¡ç† ==========
git add .
git commit -m "ç”Ÿæˆä»£ç "
git diff                                # æŸ¥çœ‹å˜åŒ–
```

---

## ğŸ“Š å¼€å‘æ—¶é—´ä¼°ç®—

| æ­¥éª¤ | ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ |
|-----|------|---------|
| 1ï¸âƒ£ | æ•°æ®åº“è®¾è®¡ | 10-30 åˆ†é’Ÿ |
| 2ï¸âƒ£ | ç”Ÿæˆ Model | 2 åˆ†é’Ÿ |
| 3ï¸âƒ£ | è®¾è®¡ API | 5-10 åˆ†é’Ÿ |
| 4ï¸âƒ£ | ç”Ÿæˆ API ä»£ç  | 1 åˆ†é’Ÿ |
| 5ï¸âƒ£ | ç¼–å†™ä¸šåŠ¡é€»è¾‘ | 30-120 åˆ†é’Ÿ â­ |
| **æ€»è®¡** | **å®Œæˆä¸€ä¸ªæ¨¡å—** | **çº¦ 1-3 å°æ—¶** |

---

## ğŸ”¥ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ Git ç®¡ç†å˜æ›´

```bash
# ç”Ÿæˆå‰æäº¤
git add .
git commit -m "ç”Ÿæˆä»£ç å‰"

# ç”Ÿæˆä»£ç 
sh generate/model.sh
sh generate/api.sh

# æŸ¥çœ‹å˜åŒ–
git diff
```

### 2. å…ˆé¢„è§ˆå†ç”Ÿæˆ

```bash
# æµ‹è¯•è¿æ¥
sh generate/model.sh --dry-run

# éªŒè¯è¯­æ³•
sh generate/api.sh --validate
```

### 3. ç»Ÿä¸€å‘½åé£æ ¼

```bash
# æ¨èï¼šgoZeroï¼ˆå°é©¼å³°ï¼‰
sh generate/model.sh -s goZero
sh generate/api.sh -s goZero
```

### 4. åªç”Ÿæˆéœ€è¦çš„è¡¨

```bash
# âœ… æ¨èï¼šæŒ‡å®šè¡¨å
sh generate/model.sh -t user,order

# âŒ é¿å…ï¼šç”Ÿæˆæ‰€æœ‰è¡¨ï¼ˆå¦‚æœè¡¨å¾ˆå¤šï¼‰
sh generate/model.sh
```

### 5. Model æ‰©å±•æ–¹æ³•

```go
// âœ… æ­£ç¡®ï¼šåœ¨ Model æ–‡ä»¶ä¸­æ·»åŠ è‡ªå®šä¹‰æ–¹æ³•
func (m *defaultUserModel) FindByEmail(ctx context.Context, email string) (*User, error) {
    // è‡ªå®šä¹‰æŸ¥è¯¢
}

// âŒ é”™è¯¯ï¼šä¸è¦ä¿®æ”¹ model_gen.goï¼ˆä¼šè¢«è¦†ç›–ï¼‰
```

---

## âš ï¸ å¸¸è§é”™è¯¯

### é”™è¯¯1ï¼šåœ¨ Handler ä¸­å†™ä¸šåŠ¡é€»è¾‘

```go
// âŒ é”™è¯¯
func (h *LoginHandler) Login(req *types.LoginRequest) {
    user, _ := h.userModel.FindOne(req.Username)  // ä¸è¦è¿™æ ·ï¼
    // ...
}

// âœ… æ­£ç¡®
func (h *LoginHandler) Login(req *types.LoginRequest) {
    return h.loginLogic.Login(req)  // è°ƒç”¨ Logic
}
```

### é”™è¯¯2ï¼šä¿®æ”¹ä¼šè¢«è¦†ç›–çš„æ–‡ä»¶

```
âŒ ä¸è¦ä¿®æ”¹ï¼š
- types.go
- routes.go
- *model_gen.go

âœ… å¯ä»¥ä¿®æ”¹ï¼š
- *logic.go
- *handler.go
- *model.go
```

### é”™è¯¯3ï¼šå¿˜è®°æ·»åŠ ä¾èµ–

```go
// servicecontext.go ä¸­æ·»åŠ  Model
type ServiceContext struct {
    Config    config.Config
    UserModel model.UserModel  // â† æ·»åŠ è¿™ä¸ª
}

func NewServiceContext(c config.Config) *ServiceContext {
    conn := sqlx.NewMysql(c.DataSource)
    return &ServiceContext{
        Config:    c,
        UserModel: model.NewUserModel(conn),  // â† åˆå§‹åŒ–
    }
}
```

---

## ğŸ“ è·å–å¸®åŠ©

- ğŸ“– è¯¦ç»†æ–‡æ¡£ï¼š`cat generate/README.md`
- ğŸ“ é…ç½®ç¤ºä¾‹ï¼š`cat generate/README.yaml`
- â“ å‘½ä»¤å¸®åŠ©ï¼š`sh generate/model.sh --help`
- ğŸŒ å®˜æ–¹æ–‡æ¡£ï¼š[https://go-zero.dev/](https://go-zero.dev/)

---

**ç¥å¼€å‘é¡ºåˆ©ï¼** ğŸš€

